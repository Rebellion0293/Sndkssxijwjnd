<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>메시지</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #ffffff;
      --bg-secondary: #f5f5f7;
      --bg-tertiary: #e8e8ed;
      --bubble-user: #007aff;
      --bubble-ai: #e9e9eb;
      --text: #1d1d1f;
      --text-secondary: #86868b;
      --text-tertiary: #aeaeb2;
      --text-on-blue: #ffffff;
      --border: rgba(0,0,0,0.08);
      --accent: #007aff;
      --danger: #ff3b30;
      --success: #30d158;
      --separator: rgba(60,60,67,0.12);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      min-height: -webkit-fill-available;
      overflow: hidden;
    }

    /* Header */
    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 56px;
      background: rgba(255,255,255,0.85);
      backdrop-filter: saturate(180%) blur(20px);
      -webkit-backdrop-filter: saturate(180%) blur(20px);
      border-bottom: 0.5px solid var(--separator);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      z-index: 100;
    }

    .header-btn {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: none;
      border: none;
      cursor: pointer;
      border-radius: 50%;
      transition: background 0.2s;
    }

    .header-btn:active {
      background: var(--bg-secondary);
    }

    .header-btn svg {
      width: 22px;
      height: 22px;
      color: var(--accent);
    }

    .header-center {
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: pointer;
      padding: 4px 12px;
      border-radius: 8px;
      transition: background 0.2s;
    }

    .header-center:active {
      background: var(--bg-secondary);
    }

    .header-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--bg-tertiary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 13px;
      color: var(--text-secondary);
      overflow: hidden;
    }

    .header-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .header-name {
      font-size: 11px;
      color: var(--text-secondary);
      margin-top: 2px;
      font-weight: 500;
    }

    /* Chat */
    .chat-container {
      position: fixed;
      top: 56px;
      bottom: 100px;
      left: 0;
      right: 0;
      overflow-y: auto;
      padding: 12px 16px;
      overscroll-behavior: contain;
    }

    .date-separator {
      text-align: center;
      margin: 16px 0;
      font-size: 12px;
      color: var(--text-tertiary);
      font-weight: 500;
    }

    .message-group {
      margin-bottom: 2px;
    }

    .message-wrapper {
      display: flex;
      margin-bottom: 2px;
    }

    .message-wrapper.user {
      justify-content: flex-end;
    }

    .message {
      max-width: 70%;
      padding: 9px 14px;
      font-size: 16px;
      line-height: 1.35;
      word-wrap: break-word;
      border-radius: 18px;
    }

    .message-wrapper.user .message {
      background: var(--bubble-user);
      color: var(--text-on-blue);
      border-bottom-right-radius: 4px;
    }

    .message-wrapper.ai .message {
      background: var(--bubble-ai);
      color: var(--text);
      border-bottom-left-radius: 4px;
    }

    .message-time {
      font-size: 11px;
      color: var(--text-tertiary);
      padding: 4px 8px 8px;
    }

    .message-wrapper.user .message-time {
      text-align: right;
    }

    /* Special Messages */
    .special-bubble {
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 180px;
      cursor: pointer;
    }

    .special-icon {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      background: var(--bg-secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .special-icon svg {
      width: 22px;
      height: 22px;
      color: var(--text-secondary);
    }

    .message-wrapper.user .special-icon {
      background: rgba(255,255,255,0.2);
    }

    .message-wrapper.user .special-icon svg {
      color: var(--text-on-blue);
    }

    .special-content {
      flex: 1;
      min-width: 0;
    }

    .special-type {
      font-size: 12px;
      opacity: 0.7;
      font-weight: 500;
    }

    .special-value {
      font-weight: 600;
      font-size: 15px;
      margin-top: 1px;
    }

    .special-desc {
      font-size: 13px;
      margin-top: 4px;
      opacity: 0.9;
      display: none;
    }

    .special-bubble.expanded .special-desc {
      display: block;
    }

    .money-amount {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: -0.5px;
    }

    /* Typing */
    .typing-indicator {
      padding: 12px 16px;
      color: var(--text-secondary);
      font-size: 13px;
      display: none;
    }

    .typing-indicator.visible {
      display: block;
    }

    /* Input Area */
    .input-area {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-top: 0.5px solid var(--separator);
      padding: 8px 12px;
      padding-bottom: max(8px, env(safe-area-inset-bottom));
    }

    .input-row {
      display: flex;
      align-items: flex-end;
      gap: 8px;
    }

    .input-actions {
      display: flex;
      gap: 2px;
    }

    .action-btn {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: none;
      border: none;
      cursor: pointer;
      border-radius: 50%;
      transition: background 0.15s;
    }

    .action-btn:active {
      background: var(--bg-secondary);
    }

    .action-btn svg {
      width: 24px;
      height: 24px;
      color: var(--text-secondary);
    }

    .input-wrapper {
      flex: 1;
      background: var(--bg-secondary);
      border-radius: 20px;
      padding: 8px 14px;
      display: flex;
      align-items: flex-end;
      min-height: 36px;
    }

    .input-wrapper textarea {
      flex: 1;
      border: none;
      background: none;
      font-size: 16px;
      font-family: inherit;
      resize: none;
      max-height: 100px;
      outline: none;
      line-height: 1.35;
      color: var(--text);
    }

    .input-wrapper textarea::placeholder {
      color: var(--text-tertiary);
    }

    .send-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: opacity 0.15s, transform 0.15s;
      flex-shrink: 0;
    }

    .send-btn:active {
      transform: scale(0.92);
    }

    .send-btn:disabled {
      opacity: 0.4;
    }

    .send-btn svg {
      width: 18px;
      height: 18px;
      color: white;
    }

    .ai-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: 2px solid var(--accent);
      background: var(--bg);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.15s;
      flex-shrink: 0;
    }

    .ai-btn:active {
      background: var(--accent);
    }

    .ai-btn:active svg {
      color: white;
    }

    .ai-btn svg {
      width: 18px;
      height: 18px;
      color: var(--accent);
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      display: none;
      align-items: flex-end;
      justify-content: center;
      z-index: 1000;
    }

    .modal-overlay.visible {
      display: flex;
    }

    .modal {
      background: var(--bg);
      border-radius: 16px 16px 0 0;
      width: 100%;
      max-width: 500px;
      max-height: 85vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from { transform: translateY(100%); }
      to { transform: translateY(0); }
    }

    .modal-header {
      padding: 16px 20px;
      border-bottom: 0.5px solid var(--separator);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }

    .modal-title {
      font-size: 17px;
      font-weight: 600;
    }

    .modal-close {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: var(--bg-secondary);
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .modal-close svg {
      width: 16px;
      height: 16px;
      color: var(--text-secondary);
    }

    .modal-body {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-input, .form-textarea, .form-select {
      width: 100%;
      padding: 14px 16px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-family: inherit;
      background: var(--bg-secondary);
      color: var(--text);
      transition: box-shadow 0.2s;
    }

    .form-input:focus, .form-textarea:focus, .form-select:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(0,122,255,0.2);
    }

    .form-textarea {
      min-height: 120px;
      resize: vertical;
      line-height: 1.5;
    }

    .form-btn {
      width: 100%;
      padding: 16px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.15s;
    }

    .form-btn:active {
      opacity: 0.8;
    }

    .form-btn.primary {
      background: var(--accent);
      color: white;
    }

    .form-btn.danger {
      background: var(--danger);
      color: white;
      margin-top: 12px;
    }

    .form-btn.secondary {
      background: var(--bg-secondary);
      color: var(--text);
      margin-top: 12px;
    }

    /* Tabs */
    .tabs {
      display: flex;
      background: var(--bg-secondary);
      border-radius: 10px;
      padding: 3px;
      margin-bottom: 20px;
    }

    .tab-btn {
      flex: 1;
      padding: 10px 12px;
      background: none;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
    }

    .tab-btn.active {
      background: var(--bg);
      color: var(--text);
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Character List */
    .char-item {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px;
      background: var(--bg-secondary);
      border-radius: 14px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: transform 0.15s;
    }

    .char-item:active {
      transform: scale(0.98);
    }

    .char-item.active {
      background: rgba(0,122,255,0.1);
      box-shadow: inset 0 0 0 2px var(--accent);
    }

    .char-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: var(--bg-tertiary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 18px;
      color: var(--text-secondary);
      flex-shrink: 0;
      overflow: hidden;
    }

    .char-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .char-info {
      flex: 1;
      min-width: 0;
    }

    .char-name {
      font-weight: 600;
      font-size: 16px;
    }

    .char-desc {
      font-size: 14px;
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-top: 2px;
    }

    .char-edit {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--bg);
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .char-edit svg {
      width: 18px;
      height: 18px;
      color: var(--text-secondary);
    }

    /* Avatar Upload */
    .avatar-upload {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      margin-bottom: 24px;
    }

    .avatar-preview {
      width: 88px;
      height: 88px;
      border-radius: 50%;
      background: var(--bg-secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      font-weight: 600;
      color: var(--text-tertiary);
      cursor: pointer;
      overflow: hidden;
      transition: opacity 0.15s;
    }

    .avatar-preview:active {
      opacity: 0.7;
    }

    .avatar-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .avatar-hint {
      font-size: 13px;
      color: var(--text-secondary);
    }

    /* Model List */
    .model-list {
      max-height: 180px;
      overflow-y: auto;
    }

    .model-item {
      padding: 14px 16px;
      background: var(--bg-secondary);
      border-radius: 10px;
      margin-bottom: 8px;
      cursor: pointer;
      font-size: 15px;
      transition: all 0.15s;
    }

    .model-item:active {
      transform: scale(0.98);
    }

    .model-item.selected {
      background: rgba(0,122,255,0.1);
      box-shadow: inset 0 0 0 2px var(--accent);
      color: var(--accent);
      font-weight: 600;
    }

    /* Slider */
    .slider-row {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .slider {
      flex: 1;
      -webkit-appearance: none;
      height: 4px;
      border-radius: 2px;
      background: var(--bg-tertiary);
    }

    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--bg);
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      cursor: pointer;
    }

    .slider-val {
      min-width: 70px;
      text-align: right;
      font-size: 15px;
      font-weight: 600;
      color: var(--text-secondary);
    }

    /* API Status */
    .api-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--text-secondary);
      margin-top: 8px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .status-dot.on { background: var(--success); }
    .status-dot.off { background: var(--danger); }

    /* Context Menu */
    .ctx-menu {
      position: fixed;
      background: var(--bg);
      border-radius: 14px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.15);
      display: none;
      z-index: 1001;
      overflow: hidden;
      min-width: 160px;
    }

    .ctx-menu.visible {
      display: block;
    }

    .ctx-item {
      padding: 14px 18px;
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .ctx-item:active {
      background: var(--bg-secondary);
    }

    .ctx-item.danger {
      color: var(--danger);
    }

    .ctx-item svg {
      width: 20px;
      height: 20px;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 80px 20px;
      color: var(--text-secondary);
    }

    .empty-icon {
      width: 64px;
      height: 64px;
      margin: 0 auto 16px;
      color: var(--text-tertiary);
    }

    .empty-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 6px;
    }

    .empty-desc {
      font-size: 15px;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 120px;
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: var(--text);
      color: var(--bg);
      padding: 14px 24px;
      border-radius: 100px;
      font-size: 15px;
      font-weight: 500;
      z-index: 2000;
      opacity: 0;
      transition: all 0.3s;
      pointer-events: none;
    }

    .toast.visible {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    /* Action Sheet - Refined */
    .action-sheet-container {
      width: 100%;
      max-width: 400px;
      padding: 0 10px 10px;
    }

    .action-sheet {
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 14px;
      overflow: hidden;
    }

    .action-sheet-header {
      padding: 16px;
      text-align: center;
      border-bottom: 0.5px solid var(--separator);
    }

    .action-sheet-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .action-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 4px;
      padding: 16px 12px;
    }

    .action-grid-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      padding: 12px 4px;
      cursor: pointer;
      border-radius: 12px;
      transition: background 0.15s;
    }

    .action-grid-item:active {
      background: var(--bg-secondary);
    }

    .action-grid-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      background: var(--bg-secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.15s;
    }

    .action-grid-item:active .action-grid-icon {
      transform: scale(0.95);
    }

    .action-grid-icon svg {
      width: 24px;
      height: 24px;
      color: var(--text-secondary);
    }

    .action-grid-label {
      font-size: 11px;
      font-weight: 500;
      color: var(--text-secondary);
      text-align: center;
    }

    .action-cancel {
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 14px;
      margin-top: 8px;
      padding: 16px;
      text-align: center;
      font-size: 17px;
      font-weight: 600;
      color: var(--accent);
      cursor: pointer;
    }

    .action-cancel:active {
      background: rgba(240,240,240,0.95);
    }

    /* Icons */
    .icon {
      display: inline-flex;
    }
  </style>
</head>
<body>
  <header class="header">
    <button class="header-btn" onclick="openSettings()">
      <svg fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><circle cx="12" cy="12" r="3"/></svg>
    </button>
    <div class="header-center" onclick="openCharacters()">
      <div class="header-avatar" id="headerAvatar">?</div>
      <span class="header-name" id="headerName">캐릭터 선택</span>
    </div>
    <button class="header-btn" onclick="confirmClear()">
      <svg fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
    </button>
  </header>

  <div class="chat-container" id="chatContainer">
    <div class="empty-state" id="emptyState">
      <svg class="empty-icon" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
      <div class="empty-title">대화를 시작하세요</div>
      <div class="empty-desc">캐릭터를 선택하고 메시지를 보내보세요</div>
    </div>
  </div>

  <div class="typing-indicator" id="typingIndicator"></div>

  <div class="input-area">
    <div class="input-row">
      <div class="input-actions">
        <button class="action-btn" onclick="openAttach()">
          <svg fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4"/></svg>
        </button>
      </div>
      <div class="input-wrapper">
        <textarea id="msgInput" rows="1" placeholder="메시지" oninput="autoResize(this)" onkeydown="handleInputKey(event)"></textarea>
      </div>
      <button class="send-btn" onclick="sendMessage()">
        <svg fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
      </button>
      <button class="ai-btn" onclick="generateAI()">
        <svg fill="currentColor" viewBox="0 0 24 24"><path d="M12 2L9.5 9.5 2 12l7.5 2.5L12 22l2.5-7.5L22 12l-7.5-2.5L12 2z"/></svg>
      </button>
    </div>
  </div>

  <div class="modal-overlay" id="attachSheet" onclick="closeModal('attachSheet')">
    <div class="action-sheet-container" onclick="event.stopPropagation()">
      <div class="action-sheet">
        <div class="action-sheet-header">
          <span class="action-sheet-title">보내기</span>
        </div>
        <div class="action-grid">
          <div class="action-grid-item" onclick="openSpecial('photo')">
            <div class="action-grid-icon">
              <svg fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
            </div>
            <span class="action-grid-label">사진</span>
          </div>
          <div class="action-grid-item" onclick="openSpecial('video')">
            <div class="action-grid-icon">
              <svg fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><rect x="2" y="5" width="20" height="14" rx="2"/><polygon points="10,9 16,12 10,15" fill="currentColor" stroke="none"/></svg>
            </div>
            <span class="action-grid-label">동영상</span>
          </div>
          <div class="action-grid-item" onclick="openSpecial('money')">
            <div class="action-grid-icon">
              <svg fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>
            </div>
            <span class="action-grid-label">송금</span>
          </div>
          <div class="action-grid-item" onclick="openSpecial('gift')">
            <div class="action-grid-icon">
              <svg fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><rect x="3" y="8" width="18" height="13" rx="1"/><path d="M12 8v13M3 12h18"/><path d="M12 8c-2-3-6-3-6 0s4 0 6 0c2 3 6 3 6 0s-4 0-6 0"/></svg>
            </div>
            <span class="action-grid-label">선물</span>
          </div>
          <div class="action-grid-item" onclick="openSpecial('context')">
            <div class="action-grid-icon">
              <svg fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>
            </div>
            <span class="action-grid-label">오늘 하루</span>
          </div>
        </div>
      </div>
      <div class="action-cancel" onclick="closeModal('attachSheet')">취소</div>
    </div>
  </div>

  <div class="modal-overlay" id="settingsModal" onclick="closeModal('settingsModal')">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-header">
        <span class="modal-title">설정</span>
        <button class="modal-close" onclick="closeModal('settingsModal')">
          <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="tabs">
          <button class="tab-btn active" onclick="switchTab('api')">API</button>
          <button class="tab-btn" onclick="switchTab('persona')">페르소나</button>
          <button class="tab-btn" onclick="switchTab('prompt')">프롬프트</button>
        </div>

        <div class="tab-content active" id="tab-api">
          <div class="form-group">
            <label class="form-label">API 제공자</label>
            <select class="form-select" id="apiProvider" onchange="onProviderChange()">
              <option value="google">Google Gemini</option>
              <option value="deepseek">DeepSeek</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">API 키</label>
            <input type="password" class="form-input" id="apiKey" placeholder="API 키 입력">
            <div class="api-status" id="apiStatus">
              <span class="status-dot off"></span>
              <span>연결되지 않음</span>
            </div>
          </div>
          <button class="form-btn secondary" onclick="loadModels()">모델 불러오기</button>
          <div class="form-group" style="margin-top:20px">
            <label class="form-label">모델</label>
            <div class="model-list" id="modelList">
              <div style="color:var(--text-tertiary);font-size:14px;padding:16px;text-align:center">API 키를 입력하세요</div>
            </div>
          </div>
          <button class="form-btn primary" onclick="saveAPI()">저장</button>
        </div>

        <div class="tab-content" id="tab-persona">
          <div class="form-group">
            <label class="form-label">내 이름</label>
            <input type="text" class="form-input" id="userName" placeholder="이름">
          </div>
          <div class="form-group">
            <label class="form-label">내 설명</label>
            <textarea class="form-textarea" id="userDesc" placeholder="자신에 대한 설명"></textarea>
          </div>
          <button class="form-btn primary" onclick="savePersona()">저장</button>
        </div>

        <div class="tab-content" id="tab-prompt">
          <div class="form-group">
            <label class="form-label">컨텍스트 길이</label>
            <div class="slider-row">
              <input type="range" class="slider" id="ctxSlider" min="1000" max="100000" step="1000" value="10000" oninput="updateCtx()">
              <span class="slider-val" id="ctxVal">10,000</span>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">시스템 프롬프트</label>
            <textarea class="form-textarea" id="sysPrompt" style="min-height:180px" placeholder="AI의 기본 동작 설정"></textarea>
          </div>
          <button class="form-btn primary" onclick="savePrompt()">저장</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="charsModal" onclick="closeModal('charsModal')">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-header">
        <span class="modal-title">캐릭터</span>
        <button class="modal-close" onclick="closeModal('charsModal')">
          <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div class="modal-body">
        <div id="charList"></div>
        <button class="form-btn primary" onclick="openCharEdit()">+ 새 캐릭터</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="charEditModal" onclick="closeModal('charEditModal')">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-header">
        <span class="modal-title" id="charEditTitle">캐릭터 추가</span>
        <button class="modal-close" onclick="closeModal('charEditModal')">
          <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="avatar-upload">
          <div class="avatar-preview" id="avatarPreview" onclick="document.getElementById('avatarInput').click()">?</div>
          <span class="avatar-hint">탭하여 사진 선택</span>
          <input type="file" id="avatarInput" accept="image/*" style="display:none" onchange="previewAvatar(event)">
        </div>
        <div class="form-group">
          <label class="form-label">이름</label>
          <input type="text" class="form-input" id="charName" placeholder="캐릭터 이름">
        </div>
        <div class="form-group">
          <label class="form-label">한 줄 설명</label>
          <input type="text" class="form-input" id="charDesc" placeholder="짧은 설명">
        </div>
        <div class="form-group">
          <label class="form-label">캐릭터 프롬프트</label>
          <textarea class="form-textarea" id="charPrompt" style="min-height:150px" placeholder="성격, 말투, 배경 등"></textarea>
        </div>
        <button class="form-btn primary" onclick="saveChar()">저장</button>
        <button class="form-btn danger" id="charDelBtn" style="display:none" onclick="deleteChar()">삭제</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="specialModal" onclick="closeModal('specialModal')">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-header">
        <span class="modal-title" id="specialTitle">입력</span>
        <button class="modal-close" onclick="closeModal('specialModal')">
          <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group" id="amountGroup" style="display:none">
          <label class="form-label">금액 (원)</label>
          <input type="number" class="form-input" id="specialAmount" placeholder="금액">
        </div>
        <div class="form-group">
          <label class="form-label" id="specialLabel">설명</label>
          <textarea class="form-textarea" id="specialDesc" placeholder="설명 입력"></textarea>
        </div>
        <button class="form-btn primary" onclick="sendSpecial()">보내기</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="editModal" onclick="closeModal('editModal')">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-header">
        <span class="modal-title">메시지 수정</span>
        <button class="modal-close" onclick="closeModal('editModal')">
          <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div class="modal-body">
        <textarea class="form-textarea" id="editContent"></textarea>
        <button class="form-btn primary" onclick="saveEdit()">저장</button>
      </div>
    </div>
  </div>

  <div class="ctx-menu" id="ctxMenu">
    <div class="ctx-item" onclick="editMsg()">
      <svg fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
      수정
    </div>
    <div class="ctx-item danger" onclick="deleteMsg()">
      <svg fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
      삭제
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    let state = {
      chatHistory: {}, // charId -> messages[]
      characters: [],
      currentChar: null,
      settings: {
        provider: 'google',
        apiKey: '',
        model: '',
        contextLen: 10000,
        sysPrompt: '',
        userName: '',
        userDesc: ''
      },
      models: [],
      editCharId: null,
      editMsgIdx: null,
      specialType: null
    };

    // Global variable to store the empty state HTML string
    let emptyStateContent = '';

    function getCurrentMessages() {
      if (!state.currentChar) return [];
      if (!state.chatHistory[state.currentChar]) {
        state.chatHistory[state.currentChar] = [];
      }
      return state.chatHistory[state.currentChar];
    }

    function setCurrentMessages(messages) {
      if (!state.currentChar) return;
      state.chatHistory[state.currentChar] = messages;
    }

    function init() {
      const saved = localStorage.getItem('chatState');
      if (saved) {
        const p = JSON.parse(saved);
        state = { ...state, ...p };
        // Migration: old messages array to chatHistory
        if (p.messages && p.currentChar && !state.chatHistory[p.currentChar]) {
          state.chatHistory[p.currentChar] = p.messages;
        }
      }

      // Save the empty state HTML once on init so we can reuse it
      const emptyEl = document.getElementById('emptyState');
      if (emptyEl) {
        emptyStateContent = emptyEl.outerHTML;
      }

      renderChat();
      updateHeader();
    }

    function save() {
      localStorage.setItem('chatState', JSON.stringify({
        chatHistory: state.chatHistory,
        characters: state.characters,
        currentChar: state.currentChar,
        settings: state.settings
      }));
    }

    // Modals
    function openModal(id) { document.getElementById(id).classList.add('visible'); }
    function closeModal(id) { document.getElementById(id).classList.remove('visible'); }

    function openSettings() {
      document.getElementById('apiProvider').value = state.settings.provider;
      document.getElementById('apiKey').value = state.settings.apiKey;
      document.getElementById('userName').value = state.settings.userName;
      document.getElementById('userDesc').value = state.settings.userDesc;
      document.getElementById('ctxSlider').value = state.settings.contextLen;
      document.getElementById('sysPrompt').value = state.settings.sysPrompt;
      updateCtx();
      updateApiStatus();
      renderModels();
      openModal('settingsModal');
    }

    function openCharacters() {
      renderCharList();
      openModal('charsModal');
    }

    function openAttach() {
      closeModal('attachSheet');
      setTimeout(() => openModal('attachSheet'), 10);
    }

    function openSpecial(type) {
      closeModal('attachSheet');
      state.specialType = type;
      const titles = { photo: '사진 보내기', video: '동영상 보내기', money: '송금하기', gift: '선물 보내기', context: '오늘 하루' };
      const labels = { photo: '어떤 사진인가요?', video: '어떤 영상인가요?', money: '메모 (선택)', gift: '무슨 선물인가요?', context: '오늘 무슨 일이 있었나요?' };
      document.getElementById('specialTitle').textContent = titles[type];
      document.getElementById('specialLabel').textContent = labels[type];
      document.getElementById('amountGroup').style.display = type === 'money' ? 'block' : 'none';
      document.getElementById('specialAmount').value = '';
      document.getElementById('specialDesc').value = '';
      openModal('specialModal');
    }

    function openCharEdit(id = null) {
      state.editCharId = id;
      const c = id ? state.characters.find(x => x.id === id) : null;
      document.getElementById('charEditTitle').textContent = c ? '캐릭터 수정' : '새 캐릭터';
      document.getElementById('charName').value = c?.name || '';
      document.getElementById('charDesc').value = c?.desc || '';
      document.getElementById('charPrompt').value = c?.prompt || '';
      document.getElementById('charDelBtn').style.display = c ? 'block' : 'none';
      const preview = document.getElementById('avatarPreview');
      preview.innerHTML = c?.avatar ? `<img src="${c.avatar}">` : (c?.name?.[0] || '?');
      closeModal('charsModal');
      openModal('charEditModal');
    }

    // Tabs
    function switchTab(tab) {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.querySelector(`[onclick="switchTab('${tab}')"]`).classList.add('active');
      document.getElementById(`tab-${tab}`).classList.add('active');
    }

    // Settings
    function onProviderChange() {
      state.settings.provider = document.getElementById('apiProvider').value;
      state.models = [];
      renderModels();
    }

    function updateCtx() {
      const v = parseInt(document.getElementById('ctxSlider').value);
      document.getElementById('ctxVal').textContent = v.toLocaleString();
    }

    function updateApiStatus() {
      const s = document.getElementById('apiStatus');
      const ok = state.settings.apiKey && state.settings.model;
      s.innerHTML = `<span class="status-dot ${ok ? 'on' : 'off'}"></span><span>${ok ? '연결됨' : '연결되지 않음'}</span>`;
    }

    async function loadModels() {
      const key = document.getElementById('apiKey').value;
      if (!key) { toast('API 키를 입력하세요'); return; }
      const p = document.getElementById('apiProvider').value;
      state.models = p === 'google' ? [
        { id: 'gemini-2.0-flash-exp', name: 'Gemini 2.0 Flash' },
        { id: 'gemini-1.5-pro', name: 'Gemini 1.5 Pro' },
        { id: 'gemini-1.5-flash', name: 'Gemini 1.5 Flash' }
      ] : [
        { id: 'deepseek-chat', name: 'DeepSeek Chat' },
        { id: 'deepseek-reasoner', name: 'DeepSeek Reasoner' }
      ];
      renderModels();
      toast('모델을 불러왔습니다');
    }

    function renderModels() {
      const el = document.getElementById('modelList');
      if (!state.models.length) {
        el.innerHTML = '<div style="color:var(--text-tertiary);font-size:14px;padding:16px;text-align:center">API 키를 입력하세요</div>';
        return;
      }
      el.innerHTML = state.models.map(m => `<div class="model-item ${state.settings.model === m.id ? 'selected' : ''}" onclick="selectModel('${m.id}')">${m.name}</div>`).join('');
    }

    function selectModel(id) {
      state.settings.model = id;
      renderModels();
    }

    function saveAPI() {
      state.settings.provider = document.getElementById('apiProvider').value;
      state.settings.apiKey = document.getElementById('apiKey').value;
      save();
      updateApiStatus();
      toast('저장되었습니다');
      closeModal('settingsModal');
    }

    function savePersona() {
      state.settings.userName = document.getElementById('userName').value;
      state.settings.userDesc = document.getElementById('userDesc').value;
      save();
      toast('저장되었습니다');
    }

    function savePrompt() {
      state.settings.contextLen = parseInt(document.getElementById('ctxSlider').value);
      state.settings.sysPrompt = document.getElementById('sysPrompt').value;
      save();
      toast('저장되었습니다');
    }

    // Characters
    function renderCharList() {
      const el = document.getElementById('charList');
      if (!state.characters.length) {
        el.innerHTML = '<div style="text-align:center;color:var(--text-secondary);padding:30px">캐릭터가 없습니다</div>';
        return;
      }
      el.innerHTML = state.characters.map(c => `
        <div class="char-item ${state.currentChar === c.id ? 'active' : ''}" onclick="selectChar('${c.id}')">
          <div class="char-avatar">${c.avatar ? `<img src="${c.avatar}">` : c.name[0]}</div>
          <div class="char-info">
            <div class="char-name">${esc(c.name)}</div>
            <div class="char-desc">${esc(c.desc || '설명 없음')}</div>
          </div>
          <button class="char-edit" onclick="event.stopPropagation();openCharEdit('${c.id}')">
            <svg fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
          </button>
        </div>
      `).join('');
    }

    function selectChar(id) {
      state.currentChar = id;
      save();
      updateHeader();
      renderChat();
      closeModal('charsModal');
      toast('캐릭터가 선택되었습니다');
    }

    function previewAvatar(e) {
      const f = e.target.files[0];
      if (f) {
        const r = new FileReader();
        r.onload = ev => { document.getElementById('avatarPreview').innerHTML = `<img src="${ev.target.result}">`; };
        r.readAsDataURL(f);
      }
    }

    function saveChar() {
      const name = document.getElementById('charName').value.trim();
      if (!name) { toast('이름을 입력하세요'); return; }
      const desc = document.getElementById('charDesc').value.trim();
      const prompt = document.getElementById('charPrompt').value.trim();
      const avatarImg = document.querySelector('#avatarPreview img');
      const avatar = avatarImg?.src || '';

      if (state.editCharId) {
        const i = state.characters.findIndex(c => c.id === state.editCharId);
        if (i !== -1) state.characters[i] = { ...state.characters[i], name, desc, prompt, avatar };
      } else {
        state.characters.push({ id: Date.now().toString(), name, desc, prompt, avatar });
      }
      save();
      updateHeader();
      closeModal('charEditModal');
      toast('저장되었습니다');
    }

    function deleteChar() {
      if (!state.editCharId) return;
      state.characters = state.characters.filter(c => c.id !== state.editCharId);
      if (state.currentChar === state.editCharId) {
        state.currentChar = null;
        delete state.chatHistory[state.editCharId];
      }
      save();
      updateHeader();
      renderChat();
      closeModal('charEditModal');
      toast('삭제되었습니다');
    }

    function updateHeader() {
      const c = state.characters.find(x => x.id === state.currentChar);
      const av = document.getElementById('headerAvatar');
      const nm = document.getElementById('headerName');
      if (c) {
        av.innerHTML = c.avatar ? `<img src="${c.avatar}">` : c.name[0];
        nm.textContent = c.name;
      } else {
        av.innerHTML = '?';
        nm.textContent = '캐릭터 선택';
      }
    }

    // Messages
    function renderChat() {
      const el = document.getElementById('chatContainer');
      const messages = getCurrentMessages();
      
      // FIX: Use stored HTML string instead of trying to manipulate the element directly
      // This prevents the error where the emptyState element is removed from DOM and then accessed again
      if (!messages.length) {
        el.innerHTML = emptyStateContent;
        return;
      }

      let html = '';
      let lastDate = '';
      messages.forEach((m, i) => {
        const d = new Date(m.ts);
        const dateStr = d.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
        const timeStr = d.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });

        if (dateStr !== lastDate) {
          html += `<div class="date-separator">${dateStr}</div>`;
          lastDate = dateStr;
        }

        html += `<div class="message-wrapper ${m.role}" data-idx="${i}" oncontextmenu="showCtx(event,${i})" ontouchstart="startLong(event,${i})" ontouchend="endLong()">`;
        if (m.special) {
          html += renderSpecial(m);
        } else {
          html += `<div class="message">${esc(m.content)}</div>`;
        }
        html += `</div><div class="message-time" style="text-align:${m.role === 'user' ? 'right' : 'left'}">${timeStr}</div>`;
      });

      el.innerHTML = html;
      el.scrollTop = el.scrollHeight;
    }

    function renderSpecial(m) {
      const icons = {
        photo: '<svg fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>',
        video: '<svg fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><rect x="2" y="5" width="20" height="14" rx="2"/><polygon points="10,9 16,12 10,15" fill="currentColor" stroke="none"/></svg>',
        money: '<svg fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>',
        gift: '<svg fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><rect x="3" y="8" width="18" height="13" rx="1"/><path d="M12 8v13M3 12h18"/><path d="M12 8c-2-3-6-3-6 0s4 0 6 0c2 3 6 3 6 0s-4 0-6 0"/></svg>',
        context: '<svg fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>'
      };
      const labels = { photo: '사진', video: '동영상', money: '송금', gift: '선물', context: '오늘 하루' };

      if (m.special === 'money') {
        return `<div class="message"><div class="special-bubble">
          <div class="special-icon">${icons.money}</div>
          <div class="special-content">
            <div class="special-type">${labels.money}</div>
            <div class="money-amount">₩${parseInt(m.amount).toLocaleString()}</div>
            ${m.content ? `<div class="special-desc" style="display:block">${esc(m.content)}</div>` : ''}
          </div>
        </div></div>`;
      }

      return `<div class="message"><div class="special-bubble" onclick="this.classList.toggle('expanded')">
        <div class="special-icon">${icons[m.special]}</div>
        <div class="special-content">
          <div class="special-type">${labels[m.special]}</div>
          <div class="special-value">탭하여 보기</div>
          <div class="special-desc">${esc(m.content)}</div>
        </div>
      </div></div>`;
    }

    function esc(t) {
      const d = document.createElement('div');
      d.textContent = t;
      return d.innerHTML;
    }

    // Input
    function autoResize(el) {
      el.style.height = 'auto';
      el.style.height = Math.min(el.scrollHeight, 100) + 'px';
    }

    function handleInputKey(e) {
      // Send on Enter without Shift, preventing default behavior (newline)
      // Check !e.isComposing to avoid issues with Korean IME composition
      if (e.key === 'Enter' && !e.shiftKey && !e.nativeEvent?.isComposing) {
        e.preventDefault();
        sendMessage();
      }
    }

    function sendMessage() {
      const inp = document.getElementById('msgInput');
      const txt = inp.value.trim();
      if (!txt) return;
      
      const messages = getCurrentMessages();
      messages.push({ role: 'user', content: txt, ts: Date.now() });
      setCurrentMessages(messages);
      
      inp.value = '';
      autoResize(inp);
      save();
      renderChat();
    }

    function sendSpecial() {
      const desc = document.getElementById('specialDesc').value.trim();
      const amt = document.getElementById('specialAmount').value;
      if (state.specialType === 'money' && !amt) { toast('금액을 입력하세요'); return; }
      if (state.specialType !== 'money' && !desc) { toast('설명을 입력하세요'); return; }

      const m = { role: state.specialType === 'context' ? 'system' : 'user', content: desc, special: state.specialType, ts: Date.now() };
      if (state.specialType === 'money') m.amount = amt;
      
      const messages = getCurrentMessages();
      messages.push(m);
      setCurrentMessages(messages);
      
      save();
      renderChat();
      closeModal('specialModal');
    }

    // AI
    async function generateAI() {
      if (!state.settings.apiKey || !state.settings.model) { toast('API 설정을 완료하세요'); return; }
      if (!state.currentChar) { toast('캐릭터를 선택하세요'); return; }
      const char = state.characters.find(c => c.id === state.currentChar);
      if (!char) { toast('캐릭터를 찾을 수 없습니다'); return; }

      const typing = document.getElementById('typingIndicator');
      typing.textContent = `${char.name}님이 입력 중...`;
      typing.classList.add('visible');

      try {
        const now = new Date();
        const dateStr = now.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
        const timeStr = now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });

        const sys = buildSys(char, dateStr, timeStr);
        const msgs = buildMsgs(sys);

        let res;
        if (state.settings.provider === 'google') {
          res = await callGoogle(msgs);
        } else {
          res = await callDeepSeek(msgs);
        }

        const messages = getCurrentMessages();
        const lines = res.split('\n').filter(l => l.trim());
        for (const line of lines) {
          messages.push({ role: 'ai', content: line.trim(), ts: Date.now() });
        }
        setCurrentMessages(messages);
        save();
        renderChat();
      } catch (e) {
        console.error(e);
        toast('오류: ' + e.message);
      } finally {
        typing.classList.remove('visible');
      }
    }

    function buildSys(char, date, time) {
      let p = state.settings.sysPrompt ? state.settings.sysPrompt + '\n\n' : '';
      p += `[캐릭터: ${char.name}]\n${char.prompt || '(설정 없음)'}\n\n`;
      if (state.settings.userName || state.settings.userDesc) {
        p += `[대화 상대]\n`;
        if (state.settings.userName) p += `이름: ${state.settings.userName}\n`;
        if (state.settings.userDesc) p += `설명: ${state.settings.userDesc}\n`;
        p += '\n';
      }
      p += `[현재 시간]\n날짜: ${date}\n시간: ${time}`;
      return p;
    }

    function buildMsgs(sys) {
      const msgs = [{ role: 'system', content: sys }];
      let len = sys.length;
      const max = state.settings.contextLen;
      const recent = [];
      const messages = getCurrentMessages();

      for (let i = messages.length - 1; i >= 0; i--) {
        const m = messages[i];
        let c = m.content;
        if (m.special) {
          const lb = { photo: '사진', video: '동영상', money: '송금', gift: '선물', context: '상황' };
          c = m.special === 'money' ? `[${lb.money}: ₩${parseInt(m.amount).toLocaleString()}] ${c}` : `[${lb[m.special]}] ${c}`;
        }
        if (len + c.length > max) break;
        len += c.length;
        recent.unshift({ role: m.role === 'ai' ? 'assistant' : 'user', content: c });
      }
      return [...msgs, ...recent];
    }

    async function callGoogle(msgs) {
      const sys = msgs.find(m => m.role === 'system');
      const chat = msgs.filter(m => m.role !== 'system');
      const contents = chat.map(m => ({ role: m.role === 'assistant' ? 'model' : 'user', parts: [{ text: m.content }] }));

      const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${state.settings.model}:generateContent?key=${state.settings.apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents,
          systemInstruction: { parts: [{ text: sys.content }] },
          generationConfig: { temperature: 0.9, maxOutputTokens: 2048 }
        })
      });
      const d = await r.json();
      if (d.error) throw new Error(d.error.message);
      return d.candidates[0].content.parts[0].text;
    }

    async function callDeepSeek(msgs) {
      const r = await fetch('https://api.deepseek.com/v1/chat/completions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${state.settings.apiKey}` },
        body: JSON.stringify({ model: state.settings.model, messages: msgs, temperature: 0.9, max_tokens: 2048 })
      });
      const d = await r.json();
      if (d.error) throw new Error(d.error.message);
      return d.choices[0].message.content;
    }

    // Context menu
    let longTimer;
    function startLong(e, i) { longTimer = setTimeout(() => showCtx(e, i), 500); }
    function endLong() { clearTimeout(longTimer); }

    function showCtx(e, i) {
      e.preventDefault();
      state.editMsgIdx = i;
      const menu = document.getElementById('ctxMenu');
      const x = e.touches ? e.touches[0].clientX : e.clientX;
      const y = e.touches ? e.touches[0].clientY : e.clientY;
      menu.style.left = Math.min(x, window.innerWidth - 180) + 'px';
      menu.style.top = Math.min(y, window.innerHeight - 120) + 'px';
      menu.classList.add('visible');
      setTimeout(() => document.addEventListener('click', hideCtx, { once: true }), 0);
    }

    function hideCtx() { document.getElementById('ctxMenu').classList.remove('visible'); }

    function editMsg() {
      hideCtx();
      const messages = getCurrentMessages();
      document.getElementById('editContent').value = messages[state.editMsgIdx].content;
      openModal('editModal');
    }

    function saveEdit() {
      const c = document.getElementById('editContent').value.trim();
      if (!c) { toast('내용을 입력하세요'); return; }
      const messages = getCurrentMessages();
      messages[state.editMsgIdx].content = c;
      setCurrentMessages(messages);
      save();
      renderChat();
      closeModal('editModal');
      toast('수정되었습니다');
    }

    function deleteMsg() {
      hideCtx();
      const messages = getCurrentMessages();
      messages.splice(state.editMsgIdx, 1);
      setCurrentMessages(messages);
      save();
      renderChat();
      toast('삭제되었습니다');
    }

    function confirmClear() {
      if (confirm('현재 캐릭터와의 대화를 모두 삭제할까요?')) {
        setCurrentMessages([]);
        save();
        renderChat();
        toast('삭제되었습니다');
      }
    }

    // Toast
    function toast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('visible');
      setTimeout(() => t.classList.remove('visible'), 2000);
    }

    init();
  </script>
</body>
</html>
